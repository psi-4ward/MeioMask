/**
 * Meio.Mask extension for the Contao WebCMS
 * Extends text-fields with rgxp=date|time|datim with a input-mask to improve the usability
 *
 * Based on http://mootools.net/forge/p/meiomask from FÃ¡bio M. Costa
 *
 * @copyright 4ward.media 2013 <http://www.4wardmedia.de>
 * @author Christoph Wiechert <wio@psitrax.de>
 * @licence LGPL
 */

Element.implement({tidy:function(){this.set("value",this.get("value").tidy())},getTextInRange:function(a,b){return this.get("value").substring(a,b)},getSelectedText:function(){return this.setSelectionRange?this.getTextInRange(this.getSelectionStart(),this.getSelectionEnd()):document.selection.createRange().text},getSelectedRange:function(){if(null!=this.selectionStart)return{start:this.selectionStart,end:this.selectionEnd};var a={start:0,end:0},b=this.getDocument().selection.createRange();if(!b||b.parentElement()!=this)return a;var c=b.duplicate();if("text"==this.type)a.start=0-c.moveStart("character",-1e5),a.end=a.start+b.text.length;else{var d=this.get("value"),e=d.length;c.moveToElementText(this),c.setEndPoint("StartToEnd",b),c.text.length&&(e-=d.match(/[\n\r]*$/)[0].length),a.end=e-c.text.length,c.setEndPoint("StartToStart",b),a.start=e-c.text.length}return a},getSelectionStart:function(){return this.getSelectedRange().start},getSelectionEnd:function(){return this.getSelectedRange().end},setCaretPosition:function(a){return"end"==a&&(a=this.get("value").length),this.selectRange(a,a),this},getCaretPosition:function(){return this.getSelectedRange().start},selectRange:function(a,b){if(this.setSelectionRange)this.focus(),this.setSelectionRange(a,b);else{var c=this.get("value"),d=c.substr(a,b-a).replace(/\r/g,"").length;a=c.substr(0,a).replace(/\r/g,"").length;var e=this.createTextRange();e.collapse(!0),e.moveEnd("character",a+d),e.moveStart("character",a),e.select()}return this},insertAtCursor:function(a,b){var c=this.getSelectedRange(),d=this.get("value");return this.set("value",d.substring(0,c.start)+a+d.substring(c.end,d.length)),b!==!1?this.selectRange(c.start,c.start+a.length):this.setCaretPosition(c.start+a.length),this},insertAroundCursor:function(a,b){a=Object.append({before:"",defaultMiddle:"",after:""},a);var c=this.getSelectedText()||a.defaultMiddle,d=this.getSelectedRange(),e=this.get("value");if(d.start==d.end)this.set("value",e.substring(0,d.start)+a.before+c+a.after+e.substring(d.end,e.length)),this.selectRange(d.start+a.before.length,d.end+a.before.length+c.length);else{var f=e.substring(d.start,d.end);this.set("value",e.substring(0,d.start)+a.before+f+a.after+e.substring(d.end,e.length));var g=d.start+a.before.length;b!==!1?this.selectRange(g,g+f.length):this.setCaretPosition(g+e.length)}return this}}),function(a,b){var c=a.Meio||{};Object.append(Element.NativeEvents,{paste:2,input:2}),Element.Events.paste={base:Browser.Platform.ios||Browser.opera||Browser.firefox&&3>Browser.version?"input":"paste",condition:function(a){return this.fireEvent("paste",a,1),!1}},c.Mask=new Class({Implements:[Options,Events],options:{autoTab:!1},initialize:function(a){this.setOptions(a),this.ignore=!1,this.bound={focus:0,blur:0,keydown:0,keypress:0,paste:0}},link:function(a){return a=b(a),"input"==a.get("tag")?(this.element&&this.unlink(),this.element=a,this.attach()):void 0},unlink:function(){return this.detach()},attach:function(){var a=this;null==this.maxlength&&(this.maxlength=this.element.get("maxLength")),this.element.removeAttribute("maxLength");for(var b in this.bound)this.bound[b]=function(b,c){return function(d){return b.call(a,d,c)}}(this.onMask,this[b]),this.element.addEvent(b,this.bound[b]);var c=this.element.get("value");return""!=c&&this.element.set("value",this.mask(c)),this},detach:function(){var a=this.maxlength;null!=a&&this.element.set("maxlength",a);for(var b in this.bound)this.element.removeEvent(b,this.bound[b]),this.bound[b]=0;return this.element=null,this},dettach:function(){this.detach()},onMask:function(a,b){if(this.element.get("readonly"))return!0;var c={},d=a.event,e="paste"==a.type?null:d.keyCode;return c.range=this.element.getSelectedRange(),c.isSelection=c.range.start!==c.range.end,c.isDelKey=46==e&&("keypress"!=d.type||(Browser.firefox||Browser.opera)&&!d.which),c.isBksKey=8==e||Browser.Platform.ios&&127==a.code,c.isRemoveKey=c.isBksKey||c.isDelKey,b&&b.call(this,a,c),!0},keydown:function(a,b){if(this.ignore=c.Mask.ignoreKeys[a.code]&&!b.isRemoveKey||a.control||a.meta||a.alt,this.ignore||b.isRemoveKey){var d=c.Mask.ignoreKeys[a.code]||"";this.fireEvent("valid",[this.element,a.code,d])}return c.Mask.onlyKeyDownRepeat&&b.isRemoveKey?this.keypress(a,b):!0},keypress:function(){if(this.options.autoTab&&this.shouldFocusNext()){var c=this.getNextInput();c&&(c.focus(),c.select&&c.select())}return!0},focus:function(){var c=this.element;c.store("meiomask:focusvalue",c.get("value"))},blur:function(a){var c=this.element;a&&c.retrieve("meiomask:focusvalue")!=c.get("value")&&c.fireEvent("change")},getCurrentState:function(a,b){var c=String.fromCharCode(a.code),d=this.element.get("value"),e=b.range.start,f=b.range.end;return b.isRemoveKey&&!b.isSelection&&(b.isDelKey?f++:e--),{value:d.substring(0,e)+(b.isRemoveKey?"":c)+d.substring(f),_char:c,start:e,end:f}},setSize:function(){this.element.get("size")||this.element.set("size",this.maskArray.length)},shouldFocusNext:function(){var a=this.options.maxLength;return a&&this.element.get("value").length>=a},getNextInput:function(){for(var c,a=Array.from(this.element.form.elements),d=a.indexOf(this.element)+1,e=a.length;e>d;d++)if(c=a[d],this.isFocusableField(c))return b(c);return null},isFocusableField:function(a){return(a.offsetWidth>0||a.offsetHeight>0)&&"fieldset"!=a.nodeName.toLowerCase()},isFixedChar:function(a){return!c.Mask.matchRules.contains(a)},mask:function(a){return a},unmask:function(a){return a}}),c.Mask.extend({matchRules:"",rulesRegex:RegExp(""),rules:{},setRule:function(a,b){var c={};c[a]=b,this.setRules(c)},setRules:function(a){Object.append(this.rules,a);var b=[];for(var c in a)b.push(c);this.matchRules+=b.join(""),this.recompileRulesRegex()},removeRule:function(a){delete this.rules[a],this.matchRules=this.matchRules.replace(a,""),this.recompileRulesRegex()},removeRules:function(){for(var a=Array.flatten(arguments),b=a.length;b--;)this.removeRule(a[b])},recompileRulesRegex:function(){this.rulesRegex.compile("["+this.matchRules.escapeRegExp()+"]","g")},createMasks:function(a,b){a=a.capitalize();for(var c in b)this[a][c.camelCase().capitalize()]=new Class({Extends:this[a],options:b[c]})},upTo:function(a){return a=""+a,function(b,c,d){return b.charAt(c-1)==a[0]?a[1]>=d:!0}},onlyKeyDownRepeat:!!(Browser.ie||Browser.chrome||Browser.safari&&Browser.version>=4)}).extend(function(){var a,b={8:"backspace",9:"tab",13:"enter",16:"shift",17:"control",18:"alt",27:"esc",33:"page up",34:"page down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",224:"command"},c={10:"go",127:"delete"};if(Browser.Platform.ios)a=c;else{for(var d=1;12>=d;d++)b[111+d]="f"+d;a=b}return{ignoreKeys:a}}()).setRules(function(){for(var a={z:{regex:/[a-z]/},Z:{regex:/[A-Z]/},a:{regex:/[a-zA-Z]/},"*":{regex:/[0-9a-zA-Z]/},H:{regex:/[0-9a-fA-F]/},"@":{regex:/[0-9a-zA-Z\u00e7\u00e1\u00e0\u00e3\u00e2\u00e9\u00e8\u00ea\u00ed\u00ec\u00f3\u00f2\u00f5\u00f4\u00fa\u00f9\u00fc\u00f1\u00c7\u00c1\u00c0\u00c3\u00c2\u00c9\u00c8\u00ca\u00cd\u00cc\u00d3\u00d2\u00d5\u00d4\u00da\u00d9\u00dc\u00d1]/},h:{regex:/[0-9]/,check:c.Mask.upTo(23)},d:{regex:/[0-9]/,check:c.Mask.upTo(31)},m:{regex:/[0-9]/,check:c.Mask.upTo(12)}},b=0;9>=b;b++)a[b]={regex:RegExp("[0-"+b+"]")};return a}()),a.Meio=c}(this,document.id),Meio.Mask.Fixed=new Class({Extends:Meio.Mask,options:{autoSetSize:!1,placeholder:"_",removeIfInvalid:!1,removeInvalidTrailingChars:!0},initialize:function(a){this.parent(a),this.slice=Array.prototype.slice,this.maskArray=this.options.mask.split(""),this.maskMold=this.options.mask.replace(Meio.Mask.rulesRegex,this.options.placeholder).split(""),this.maskMoldEmpty=this.slice.call(this.maskMold),this.validIndexes=[],this.maskArray.each(function(a,b){this.isFixedChar(a)||this.validIndexes.push(b)},this),this.createUnmaskRegex()},link:function(a){this.parent(a);var b=this.element.get("value");if(""!=b)for(var c=this.mask(b),d=c.length;d--;)this.maskMold[d]=c.charAt(d);return this.options.autoSetSize&&this.setSize(),this},focus:function(a,b){var c=this.applyMask(this.element.get("value"),0);this.maskMold=c.value;var d=this.maskMold.join("");this.element.set("value",d),this.focusTimeout=this.element.setCaretPosition.delay(0,this.element,[this.getLastValidIndex(d)]),this.parent(a,b)},blur:function(a,b){this.parent(a,b),clearTimeout(this.focusTimeout);var c=this.element.get("value");return this.options.removeIfInvalid?(c.contains(this.options.placeholder)&&(this.maskMold=this.slice.call(this.maskMoldEmpty,0),this.element.set("value","")),!0):(this.options.removeInvalidTrailingChars&&this.element.set("value",this.removeInvalidTrailingChars(c)),!0)},keypress:function(a,b){if(this.ignore)return!0;a.preventDefault();var e,f,g,c=String.fromCharCode(a.code),d=this.maskArray;if(b.isSelection){var l,j=b.range.start,k=b.range.end;do e=this.validIndexes.indexOf(b.range.start++);while(-1==e&&b.range.start<d.length);do l=this.validIndexes.indexOf(b.range.end++);while(-1==l&&b.range.end<d.length);if(!(l-e))return!0;for(f=j;k>f;f++)this.maskMold[f]=this.maskMoldEmpty[f];if(!b.isRemoveKey){if(f=this.validIndexes[e],!(g=this.testEvents(f,c,a.code,b.isRemoveKey)))return!0;"string"==typeof g&&(c=g),this.maskMold[f]=c,e++}this.element.set("value",this.maskMold.join("")),this.element.setCaretPosition(this.validIndexes[e])}else{var h;if(b.isBksKey){do e=this.validIndexes.indexOf(--b.range.start);while(-1==e&&b.range.start>=0);h=this.validIndexes[e]||0}else{do e=this.validIndexes.indexOf(b.range.start++);while(-1==e&&b.range.start<d.length);h=-1==e?this.maskMold.length:this.validIndexes[e+1]}if(f=this.validIndexes[e],!(g=this.testEvents(f,c,a.code,b.isRemoveKey)))return!0;"string"==typeof g&&(c=g),this.maskMold[f]=b.isRemoveKey?this.options.placeholder:c;var i=null==h?this.maskMold.length:h;this.element.set("value",this.maskMold.join("")).setCaretPosition(i)}return this.parent()},paste:function(a,b){var c=this.applyMask(this.element.get("value"),b.range.start);return this.maskMold=c.value,this.element.set("value",this.maskMold.join("")).setCaretPosition(c.rangeStart),!0},getLastValidIndex:function(a){for(var e,b=a.length,c=this.options.placeholder,d=a.length-1;d>=0;){for(e=!1;this.isFixedChar(a.charAt(d))&&a.charAt(d)!==c;)0==d&&(b=0),e=!0,d--;for(;a.charAt(d)===c;)b=d,e=!0,d--;if(!e)break}return b},removeInvalidTrailingChars:function(a){return a.substring(0,this.getLastValidIndex(a))},testEvents:function(a,b,c,d){var g,e=this.maskArray,f=Meio.Mask.rules[e[a]];if(!d){var h=[this.element,c,b];if(!f||!(g=this.testEntry(this.element.get("value"),a,b)))return this.fireEvent("invalid",h),!1;this.fireEvent("valid",h)}return null!=g?g:!0},shouldFocusNext:function(){return this.unmask(this.element.get("value")).length>=this.validIndexes.length},createUnmaskRegex:function(){var a=[].combine(this.options.mask.replace(Meio.Mask.rulesRegex,"").split("")),b=(a.join("")+this.options.placeholder).escapeRegExp();this.unmaskRegex=b?RegExp("["+b+"]","g"):null},testEntry:function(a,b,c){var d=this.maskArray,e=Meio.Mask.rules[d[b]],f=e&&e.regex.test(c);return e.check&&f?e.check(a,b,c):f},applyMask:function(a,b){for(var h,c=a.split(""),d=this.maskArray,e=this.maskMold,f=Meio.Mask.rules,g=0;e.length>g;){if(c[g])if(f[d[g]]){if(!(h=this.testEntry(a,g,c[g]))){c.splice(g,1);continue}"string"==typeof h&&(c[g]=h),b=g}else d[g]!=c[g]?c.splice(g,0,e[g]):c[g]=e[g];else c[g]=e[g];g++}return{value:c.slice(0,this.maskMoldEmpty.length),rangeStart:b+1}},mask:function(a){return a=this.applyMask(a).value.join(""),this.options.removeInvalidTrailingChars&&(a=this.removeInvalidTrailingChars(a)),a},unmask:function(a){return this.unmaskRegex?a.replace(this.unmaskRegex,""):a}}),Meio.Mask.createMasks("Fixed",{Phone:{mask:"(99) 9999-9999"},PhoneUs:{mask:"(999) 999-9999"},Cpf:{mask:"999.999.999-99"},Cnpj:{mask:"99.999.999/9999-99"},Date:{mask:"3d/1m/9999"},DateUs:{mask:"1m/3d/9999"},Cep:{mask:"99999-999"},Time:{mask:"2h:59"},time:{mask:"2h:59"},Cc:{mask:"9999 9999 9999 9999"},Mac:{mask:"HH:HH:HH:HH:HH:HH"},datim:{mask:"3d.1m.9999 - 2h:59"},date:{mask:"3d.1m.9999"}}),Meio.Mask.Reverse=new Class({Extends:Meio.Mask,options:{autoSetSize:!1,autoEmpty:!1,alignText:!0,symbol:"",precision:2,decimal:",",thousands:".",maxLength:18},initialize:function(a){this.parent(a);var b=this.options.thousands,c=b.escapeRegExp(),d=this.options.decimal.escapeRegExp();this.maxlength=this.options.maxLength,this.reThousands=RegExp("^(-?[^\\D"+c+"]+)(\\d{3})"),this.reRemoveLeadingZeros=/^0+(.*)$/,this.reDecimalNumber=/^[\d+\-]$/,this.thousandsReplaceStr="$1"+b+"$2",this.reThousandsReplace=RegExp(c,"g"),this.reCleanup=RegExp("["+c+d+"]","g"),this.reRemoveNonNumbers=RegExp("[^\\d"+c+d+"]","g")},link:function(a){this.parent(a),this.options.alignText&&this.element.setStyle("text-align","right");var b=this.element.get("value");return""!==b||this.options.autoEmpty||this.element.set("value",this.forceMask(b,!1)),this},focus:function(a,b){var c=this.element,d=c.get("value");this.options.autoEmpty?""===d&&c.set("value",this.mask(d)):c.set("value",this.getValue(d,!0)),this.parent(a,b)},blur:function(a,b){this.parent(a,b);var c=this.element,d=this.getValue(c.get("value"));this.options.autoEmpty&&this.mask(d)==this.mask()&&(d=""),c.set("value",d)},keypress:function(a,b){if(this.ignore)return!0;a.preventDefault();var c=this.getCurrentState(a,b),d=c.value;if(!this.testEvents(d,c._char,a.code,b.isRemoveKey))return!0;d=this.forceMask(d,!0);var e="+"===c._char,f=this.isNegative(d);return d=e?f?d.substring(1):d:d,this.element.set("value",d).setCaretPosition(d.length),this.parent()},testEvents:function(a,b,c,d){var e=[this.element,c,b];if(!d){var f=this.getValue(a,!1).length;if(!this.reDecimalNumber.test(b)||this.maxlength&&f>this.maxlength)return this.fireEvent("invalid",e),!1;this.fireEvent("valid",e)}return!0},paste:function(){var c=this.element,d=c.get("value");return c.set("value",d=this.forceMask(d,!0)).setCaretPosition(d.length),!0},forceMask:function(a,b){var c=a.contains("-");a=this.cleanup(a);var d=this.options.precision,e=d+1-a.length;if(e>0&&(a=this.zeroize(a,e)),d){var f=a.length-d;a=a.substring(0,f)+this.options.decimal+a.substring(f)}var g=this.getValue(this.maskThousands(a),b);return this.negativize(g,c)},cleanup:function(a){return a=a.replace(this.reRemoveNonNumbers,"").replace(this.reCleanup,""),this.getValue(a).replace(this.reRemoveLeadingZeros,"$1")},mask:function(a){return a=this.unmask(a||"0").replace(".",this.options.decimal),this.getValue(this.maskThousands(a),!0)},unmask:function(a){return this.toNumber(this.getValue(a))},toNumber:function(a){var b=this.isNegative(a);if(a=a.replace(this.reRemoveNonNumbers,""),!isFinite(a)){this.options.thousands&&(a=a.replace(this.reThousandsReplace,""));var c=this.options.decimal;c&&(a=a.replace(c,"."))}var d=a.toFloat().toFixed(this.options.precision);return this.negativize(d,b)},getValue:function(a,b){var c=this.isNegative(a);a=c?a.substring(1):a;var d=this.options.symbol,e=a.substring(0,d.length)===d?b?a:a.substring(d.length):b?d+a:a;return this.negativize(e,c)},maskThousands:function(a){if(this.options.thousands)for(;this.reThousands.test(a);)a=a.replace(this.reThousands,this.thousandsReplaceStr);return a},zeroize:function(a,b){for(;b--;)a="0"+a;return a},isNegative:function(a){return 0===a.indexOf("-")},negativize:function(a,b){return b?"-"+a:a},shouldFocusNext:function(){return this.getValue(this.element.get("value"),!1).length>=this.options.maxLength}}),Meio.Mask.createMasks("Reverse",{Integer:{precision:0,maxLength:18},IntegerUs:{precision:0,maxLength:18,thousands:",",decimal:"."},Decimal:{},DecimalUs:{thousands:",",decimal:"."},Reais:{symbol:"R$ "},Euro:{symbol:"\u20ac "},Dollar:{symbol:"US$ ",thousands:",",decimal:"."}}),Meio.Mask.Repeat=new Class({Extends:Meio.Mask,options:{mask:"",maxLength:0},keypress:function(a,b){if(this.ignore)return!0;a.preventDefault();var c=this.getCurrentState(a,b),d=Meio.Mask.rules[this.options.mask.charAt(0)].regex,e=[this.element,c._char,a.code],f=this.options.maxLength;return f&&c.value.length>f||!d.test(c._char)&&!b.isRemoveKey?this.fireEvent("invalid",e):(this.fireEvent("valid",e),this.element.set("value",c.value).setCaretPosition(c.start+(b.isRemoveKey?0:1))),this.parent()},paste:function(){var c=this.mask(this.element.get("value"));this.element.set("value",c).setCaretPosition(c.length)},mask:function(a){for(var b=a.split(""),c=Meio.Mask.rules[this.options.mask.charAt(0)].regex,d=0;b.length>d;d++)c.test(b[d])||(b.splice(d,1),d--);var e=this.options.maxLength;return b.join("").substring(0,e?e:b.length)}}),function(){var a="meiomask",b=function(a){return a.camelCase().capitalize()},c=function(a,c,d){var e;return"string"==typeOf(a)?("string"!=typeOf(c)&&(d=c,a=a.split("."),c=a[1],a=a[0]),e=Meio.Mask[b(a)],c&&(e=e[b(c)])):(e=a,d=c),{klass:e,options:d||{}}},d=function(a,b){var d=c.apply(null,b);return new d.klass(d.options)[a](this)};String.implement({meiomask:function(){return d.call(this,"mask",arguments)},meiounmask:function(){return d.call(this,"unmask",arguments)}}),Element.Properties.meiomask={set:function(b){b=c.apply(null,b);var d=this.retrieve(a);return d&&(d.unlink(),d=null),this.store(a,new b.klass(b.options).link(this))},get:function(){return this.retrieve(a)},erase:function(){var b=this.retrieve(a);return b&&b.unlink(),this}},Element.Properties[a+":value"]={set:function(b){var c=this.retrieve(a);return c&&(b=c.mask(b)),this.set("value",b)},get:function(){var b=this.retrieve(a),c=this.get("value");return b?b.unmask(c):c}},Element.implement({meiomask:function(b,c,d){return this.set(a,[b,c,d])}})}();